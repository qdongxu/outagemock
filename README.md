# OutageMock

一个用于模拟系统资源消耗的Go可执行程序，可以模拟CPU使用率、内存占用和指定磁盘上的文件空间占用，用于测试和压力测试场景。

## 功能特性

- **CPU使用率模拟**: 精确控制CPU使用率（0-100%），支持线性预热
- **内存消耗**: 分配指定大小的RSS内存并进行随机访问以防止交换到磁盘，支持线性预热
- **磁盘空间占用**: 在指定路径创建指定大小的文件，支持线性预热，用于模拟磁盘空间占用
- **预热控制**: 支持设置预热时间，CPU、内存和文件大小会线性增长到目标值
- **时间控制**: 程序在指定时间后自动停止
- **优雅退出**: 支持信号处理和异常退出时的资源清理
- **自动清理**: 程序退出时自动删除临时文件，即使异常退出也会清理

## 安装和构建

```bash
# 克隆项目
git clone <repository-url>
cd outagemock

# 构建二进制文件
make build
# 或者直接使用go build
go build -o outagemock main.go
```

## 使用方法

### 基本用法

```bash
# 使用默认参数运行
./outagemock

# 查看帮助信息
./outagemock -h
```

### 命令行参数

- `-cpu float`: CPU使用率百分比 (0-100，默认: 50.0)
- `-memory int`: 内存大小，单位MB (默认: 100)
- `-fsize int`: 磁盘空间占用大小，单位MB (默认: 200)
- `-fpath string`: 文件路径，用于在指定磁盘上创建文件 (默认: "outagemock_temp_file")
- `-duration duration`: 运行时间 (默认: 30s)
- `-rampup duration`: 预热时间，CPU、内存和文件大小线性增长到目标值的时间 (默认: 10s)

### 使用示例

```bash
# 模拟75% CPU使用率，200MB内存，在/data目录占用500MB磁盘空间，运行60秒，30秒预热
./outagemock -cpu 75 -memory 200 -fsize 500 -fpath /data/test_file -duration 60s -rampup 30s

# 只消耗CPU，不消耗内存和磁盘空间，10秒预热到80%
./outagemock -cpu 80 -memory 0 -fsize 0 -duration 10s -rampup 10s

# 只消耗内存，不消耗CPU和磁盘空间，5秒预热到500MB
./outagemock -cpu 0 -memory 500 -fsize 0 -duration 30s -rampup 5s

# 只在指定磁盘上占用空间，不消耗CPU和内存，20秒预热到1GB
./outagemock -cpu 0 -memory 0 -fsize 1000 -fpath /var/log/large_file -duration 60s -rampup 20s

# 快速预热：1秒内达到目标资源使用率
./outagemock -cpu 90 -memory 1000 -fsize 0 -duration 30s -rampup 1s

# 在指定磁盘分区上占用空间
./outagemock -cpu 50 -memory 100 -fsize 200 -fpath /mnt/disk1/test_file -duration 30s -rampup 5s
```

### 使用Makefile

```bash
# 构建项目
make build

# 使用默认参数运行
make run

# 使用示例参数运行
make run-example

# 清理构建产物和临时文件
make clean

# 查看帮助
make help
```

## 工作原理

### CPU使用率控制
程序通过在高强度计算和睡眠之间切换来控制CPU使用率。支持预热功能：
- 在预热期间，CPU使用率从0%线性增长到目标值
- 预热完成后，保持目标CPU使用率
- 通过计算相应的睡眠时间来控制CPU使用率
- **多核支持**：程序会自动检测CPU核心数，并在所有核心上均匀分布负载
- **使用率含义**：50%表示占用50%的总CPU资源（所有核心的总和）

### 内存管理
- 在预热期间，内存分配从0MB线性增长到目标值
- 预热完成后，保持目标内存大小
- 用数据填充内存以确保实际分配
- 定期进行随机访问以防止操作系统将内存交换到磁盘
- 使用质数进行索引计算以获得更好的分布

### 磁盘空间占用
- 在预热期间，文件大小从0MB线性增长到目标值
- 预热完成后，保持目标文件大小
- 使用缓冲区提高写入效率
- 定期同步数据到磁盘
- 文件创建在用户指定的路径，用于模拟特定磁盘分区的空间占用

### 资源清理
- 使用`sync.Once`确保清理操作只执行一次
- 监听系统信号（SIGINT, SIGTERM）进行优雅退出
- 程序退出时自动删除临时文件
- 即使程序异常退出，也会进行资源清理

## 注意事项

1. **权限要求**: 程序需要在指定路径有写入权限以创建文件
2. **系统资源**: 请确保系统有足够的内存和磁盘空间
3. **信号处理**: 程序会响应Ctrl+C等中断信号
4. **文件清理**: 临时文件会在程序正常退出时自动删除
5. **Linux限制**: 如果进程被`kill -9`强制终止，文件可能不会被自动删除
6. **磁盘空间模拟**: 此工具用于模拟指定磁盘分区的空间占用，请确保目标路径有足够的磁盘空间
7. **CPU使用率说明**: CPU使用率基于总CPU资源（所有核心），50%表示占用50%的总CPU时间

## 故障排除

### 常见问题

1. **内存不足**: 如果系统内存不足，程序可能会被系统杀死
2. **磁盘空间不足**: 如果磁盘空间不足，文件创建会失败
3. **权限问题**: 确保程序有创建和删除文件的权限

### 调试

程序会输出详细的运行信息，包括：
- 配置参数
- 内存分配状态
- 文件创建和增长进度
- CPU使用率信息

## 许可证

本项目使用MIT许可证，详见LICENSE文件。
